<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal Family Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Performance Improvement: Preconnect to external domains -->
    <link rel="preconnect" href="https://api.openweathermap.org" crossorigin>
    <link rel="preconnect" href="https://generativelanguage.googleapis.com" crossorigin>
    <link rel="preconnect" href="https://fonts.googleapis.com">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #000;
            color: #fff;
            overflow: hidden; /* Prevents scrollbars on body */
            position: relative;
            height: 100vh;
            width: 100vw;
            /* Dynamic background styling, will be updated by JS */
            background-size: cover;
            background-position: center;
            transition: background-image 1s ease-in-out; /* Smooth transition for background image */
        }

        /* Dark Overlay for Readability */
        #background-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.25); /* Semi-transparent black overlay */
            z-index: -1;
        }

        /* Main content grid */
        #dashboard-grid {
            display: grid;
            grid-template-columns: 50% 50%; /* Enforce equal split between left and right columns */
            gap: 1.5rem; /* Space between columns */
            height: 100vh; /* Full viewport height */
            width: 100vw; /* Full viewport width */
        }

        /* Apply 2-column grid for medium screens and up */
        @media (min-width: 768px) {
            #dashboard-grid {
                grid-template-columns: 1fr 1fr; /* Two equal columns */
            }
        }

        /* Glassmorphism effect for containers */
        .widget {
            background: rgba(0, 0, 0, 0.25);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1rem; /* 16px */
            padding: 1.5rem; /* 24px */
            /* Ensure widgets within flex containers can properly flex/grow */
            display: flex;
            flex-direction: column;
            min-height: 0; /* Allow content to shrink within bounds */
        }
        .text-shadow {
            text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.7);
        }
        
        /* Standard Gemini Button (for modals, etc.) */
        .gemini-btn {
            background-color: #4285F4;
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.3s;
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        .gemini-btn:hover:not(:disabled) {
            background-color: #357ae8;
        }
        .gemini-btn:disabled {
            background-color: #9ca3af; /* Tailwind gray-400 */
            cursor: not-allowed;
        }

        /* New Glassmorphism Button Style */
        .glass-btn {
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 9999px; /* rounded-full */
            padding: 0.5rem 1rem;
            color: white;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 500;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            transition: all 0.3s ease-in-out;
            cursor: pointer;
        }
        .glass-btn:hover:not(:disabled) {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.3);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -2px rgb(0 0 0 / 0.1);
        }
        .glass-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }


        /* Custom style for the refresh calendar button to make it blend better */
        #refresh-calendar {
            background-color: rgba(0, 0, 0, 0.3); /* Slightly transparent dark background */
            border: 1px solid rgba(255, 255, 255, 0.2); /* Subtle white border */
            color: white;
            padding: 0.5rem 0.75rem; /* Adjusted padding */
            border-radius: 0.5rem; /* Rounded corners */
            font-size: 0.875rem; /* text-sm */
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.3s, border-color 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        #refresh-calendar:hover:not(:disabled) {
            background-color: rgba(255, 255, 255, 0.1); /* Lighter on hover */
            border-color: rgba(255, 255, 255, 0.4);
        }
        #refresh-calendar:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }


        .spinner {
            width: 30px; /* Larger spinner for background loading */
            height: 30px;
            border: 4px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        /* Carousel Styles */
        .carousel-container {
            position: relative;
            overflow: hidden; /* Prevent content overflow */
            height: 100%;
        }
        .carousel-track {
            display: flex;
            height: 100%;
            transition: transform 0.5s ease-in-out;
            width: 100%;
        }
        .carousel-slide {
            flex: 0 0 100%;
            width: 100%;
            height: 100%;
            box-sizing: border-box;
            padding: 0 2.5rem;
            display: flex;
            flex-direction: column;
            justify-content: center;
            text-align: center;
            white-space: normal; /* Allow text to wrap */
            word-wrap: break-word; /* Break long words */
            overflow-wrap: break-word; /* Ensure text wraps properly */
        }
        
        .carousel-button {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0,0,0,0.3);
            border-radius: 50%;
            border: none;
            color: white;
            cursor: pointer;
            padding: 0.25rem;
            z-index: 10;
        }
        .carousel-button:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        .carousel-button.left { left: 0px; }
        .carousel-button.right { right: 0px; }

        /* Custom Scrollbar */
        .scrollable-content {
            flex-grow: 1;
            overflow-y: auto; /* Allow vertical scrolling for long content */
            scrollbar-width: thin; /* Thin scrollbar for better aesthetics */
            scrollbar-color: rgba(255,255,255,0.4) rgba(255,255,255,0.1);
        }
        .scrollable-content::-webkit-scrollbar {
            width: 8px;
        }
        .scrollable-content::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }
        .scrollable-content::-webkit-scrollbar-thumb {
            background-color: rgba(255, 255, 255, 0.4);
            border-radius: 10px;
        }

        /* Adjusting column heights for calendar and other widgets */
        .main-left-column,
        .main-right-column {
            display: flex;
            flex-direction: column;
            gap: 1.5rem; /* Space between widgets */
            height: 100%; /* Full height of the grid */
            overflow: hidden; /* Prevent content overflow */
        }
        
        /* Use flex shorthand to enforce proportions */
        #calendar.widget {
            flex: 4 1 0%;
            overflow: hidden;
        }
        #conversation-starter.widget {
            flex: 2 1 0%;
        }
        #weather.widget {
            flex: 4 1 0%;
            overflow: hidden;
        }
        #verse.widget {
            flex: 2 1 0%;
            overflow: hidden;
            cursor: default; /* Default cursor */
        }
        #verse.widget.clickable {
            cursor: pointer; /* Clickable cursor when insights are loaded */
        }


        /* --- Weather Layout Styles --- */
        #weather-content {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            height: 100%;
            flex-grow: 1; /* Allow content to fill widget */
        }
        #current-conditions-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            align-items: center;
            gap: 1rem;
            text-align: left;
        }
        #weather-details {
            font-size: 1.125rem; /* text-lg */
            line-height: 1.6;
        }
        #weather-main {
            text-align: center;
        }
        #weather-temp {
            font-size: 5rem; /* text-7xl */
            font-weight: 700; /* bold */
            line-height: 1;
        }
        #weather-description {
            font-size: 1.125rem; /* text-lg */
            text-transform: capitalize;
            margin-top: -0.25rem;
        }
        #weather-icon-container {
            text-align: right;
        }
        #weather-icon {
            width: 4rem; /* w-16 */
            height: 4rem; /* h-16 */
            display: inline-block;
        }
        #chance-of-rain-container {
            font-size: 1rem; /* text-base */
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 0.5rem;
        }
        #sunrise-sunset {
            display: flex;
            justify-content: center;
            gap: 1rem;
            font-size: 0.875rem; /* text-sm */
            margin-top: 0.5rem;
        }
        .forecast-row {
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding-top: 0.5rem;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            margin-top: 0.5rem;
        }
        .forecast-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.75rem; /* text-xs */
        }
        .forecast-item .day-name {
            font-weight: 600; /* semibold */
        }
        .forecast-item .temp-range {
            font-weight: 500; /* medium */
        }
        #activity-suggestions-container {
            flex-shrink: 0;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            min-height: 100px; /* Ensure a minimum height */
            position: relative;
            margin-top: 0.5rem;
        }


        /* Mobile Responsiveness */
        @media (max-width: 768px) {
            #dashboard-grid {
                grid-template-columns: 1fr; /* Single column on mobile */
                height: auto; /* Allow height to auto-adjust for stacked content */
                overflow-y: auto; /* Allow scrolling on mobile */
            }
            .main-left-column,
            .main-right-column {
                height: auto; 
                overflow: visible;
            }
            #calendar.widget, #weather.widget, #verse.widget, #conversation-starter.widget {
                height: auto; 
                flex-grow: 0;
            }
            #calendar-iframe {
                min-height: 400px; 
            }
            .carousel-slide {
                padding: 0 1rem; 
            }
            #weather-temp {
                font-size: 4rem; 
            }
            #weather-description {
                font-size: 1.5rem; 
            }
            .text-shadow {
                text-shadow: 1px 1px 4px rgba(0, 0, 0, 0.5); 
            }
            #time-date {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }
            #refresh-calendar {
                margin-top: 0.5rem;
                align-self: flex-end; 
            }
            .forecast-row {
                justify-content: flex-start;
                gap: 1rem;
                overflow-x: auto;
                padding-bottom: 0.5rem;
            }
            .forecast-item {
                flex-shrink: 0;
            }
        }

        /* --- Modal Styles --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            z-index: 999;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background: rgba(20, 20, 20, 0.5);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 1.5rem;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }
        .modal-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .modal-body {
            padding: 1.5rem;
            flex-grow: 1;
            overflow-y: auto;
        }
        .modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        #gemini-question-input {
            width: 100%;
            background: rgba(0,0,0,0.2);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 0.5rem;
            padding: 0.75rem;
            color: white;
        }
        #gemini-answer-container {
            min-height: 100px;
            background: rgba(0,0,0,0.1);
            border-radius: 0.5rem;
            padding: 1rem;
        }

        /* --- Floating Action Button --- */
        #open-gemini-modal {
            position: fixed;
            bottom: 1.5rem;
            left: 1.5rem;
            z-index: 50;
            padding: 1rem; /* Larger padding for the floating button */
        }
        
        #open-gemini-modal span {
            display: none;
        }

        @media (min-width: 768px) {
            #open-gemini-modal span {
                display: inline;
            }
        }

        /* --- Feelings Wheel Modal Styles --- */
        #feelings-modal .modal-content {
            max-width: 95vw;
            width: 800px;
            max-height: 90vh;
        }
        #name-selection-view .name-btn {
            display: block;
            width: 100%;
            text-align: left;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s;
        }
        #name-selection-view .name-btn:hover {
            background-color: rgba(255,255,255,0.1);
        }
        #wheel-view {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .core-emotion-group .group-header {
            padding: 0.75rem;
            border-radius: 0.75rem;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.2s;
        }
        .core-emotion-group .group-header:hover {
            background-color: rgba(255,255,255,0.1);
        }
        .core-emotion-group .group-header h3 {
            font-size: 1.25rem;
            font-weight: 700;
        }
        .core-emotion-group .group-header .chevron {
            transition: transform 0.3s ease-in-out;
        }
        .core-emotion-group .group-header.open .chevron {
            transform: rotate(180deg);
        }

        .feelings-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 0.5rem;
            padding: 0.75rem;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out, padding 0.5s ease-in-out;
        }
        .feelings-list.open {
            max-height: 500px; /* Arbitrary large number */
        }

        .feeling-btn {
            width: 100%;
            padding: 0.5rem;
            border-radius: 0.5rem;
            background-color: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            cursor: pointer;
            transition: background-color 0.2s;
            font-size: 0.875rem;
        }
        .feeling-btn:hover {
            background-color: rgba(255,255,255,0.2);
        }
        
    </style>
</head>
<body class="bg-black text-white">

    <div id="background-overlay"></div>

    <div id="dashboard-grid" class="p-6">
        
        <div class="flex flex-col gap-6 min-h-0 main-left-column">
            <!-- Time and Date -->
            <div id="time-date" class="flex items-end justify-between flex-shrink-0">
                <div class="flex items-baseline gap-3">
                    <h2 id="date" class="text-3xl font-medium text-shadow"></h2>
                    <h1 id="time" class="text-6xl font-bold text-shadow -mb-2"></h1>
                    <span id="ampm" class="text-3xl font-semibold text-shadow -mb-2"></span>
                </div>
                <button id="refresh-calendar" class="text-sm px-3 py-1">
                    <i data-lucide="refresh-cw" class="w-4 h-4"></i> Refresh Calendar
                </button>
            </div>

            <!-- Calendar -->
            <div id="calendar" class="widget flex flex-col p-0 overflow-hidden">
                <iframe id="calendar-iframe" src="https://calendar.google.com/calendar/embed?src=wksest2015%40gmail.com&ctz=America%2FNew_York&mode=AGENDA" style="border: 0" width="100%" height="100%" frameborder="0" scrolling="no" sandbox="allow-scripts allow-same-origin"></iframe>
            </div>

            <!-- Conversation Starter Widget -->
            <div id="conversation-starter" class="widget flex flex-col">
                <div>
                    <h3 class="text-lg font-semibold text-white/80 mb-2">Conversation Starter ✨</h3>
                    <p id="starter-question" class="text-xl text-center font-medium leading-snug">Loading question...</p>
                </div>
                <button id="refresh-starter" class="glass-btn self-center mt-4">
                    <i data-lucide="refresh-cw" class="w-4 h-4"></i> New Question
                </button>
            </div>
        </div>

        <div class="flex flex-col gap-6 min-h-0 main-right-column">
            <!-- Weather -->
            <div id="weather" class="widget flex flex-col">
                <div id="weather-loading" class="flex-grow flex items-center justify-center text-2xl text-shadow">Loading weather...</div>
                <div id="weather-content" class="hidden">
                    <!-- Top Section: Current Conditions -->
                    <div class="flex-shrink-0">
                        <div id="current-conditions-grid">
                            <div id="weather-details" class="text-shadow">
                                <div>High: <span id="temp-high"></span></div>
                                <div>Low: <span id="temp-low"></span></div>
                                <div>Feels like: <span id="feels-like"></span></div>
                                <div>Humidity: <span id="humidity"></span></div>
                            </div>
                            <div id="weather-main" class="text-shadow">
                                <p id="weather-temp"></p>
                                <p id="weather-description"></p>
                            </div>
                            <div id="weather-icon-container" class="text-shadow">
                                <i id="weather-icon" data-lucide="sun"></i>
                                <div id="chance-of-rain-container">
                                    <i data-lucide="umbrella" class="w-5 h-5"></i>
                                    <span id="chance-of-rain"></span>
                                </div>
                            </div>
                        </div>
                        <div id="sunrise-sunset" class="text-shadow">
                            <div class="flex items-center gap-1">
                                <i data-lucide="sunrise" class="w-5 h-5"></i>
                                <span id="sunrise-time"></span>
                            </div>
                            <div class="flex items-center gap-1">
                                <i data-lucide="sunset" class="w-5 h-5"></i>
                                <span id="sunset-time"></span>
                            </div>
                        </div>
                    </div>

                    <!-- Middle Section: Forecasts -->
                    <div class="flex-shrink-0">
                        <div id="hourly-forecast" class="forecast-row"></div>
                        <div id="weather-forecast" class="forecast-row"></div>
                    </div>

                    <!-- Bottom Section: Gemini Activity Suggestions -->
                    <div id="activity-suggestions-container">
                        <div class="carousel-container">
                            <div id="gemini-weather-insight-track" class="carousel-track">
                                <div class="carousel-slide">
                                    <div class="flex items-center justify-center w-full">
                                        <span class="text-lg">✨ Loading personalized activity ideas...</span>
                                    </div>
                                </div>
                            </div>
                            <button id="prev-idea" class="carousel-button left hidden"><i data-lucide="chevron-left" class="w-6 h-6"></i></button>
                            <button id="next-idea" class="carousel-button right hidden"><i data-lucide="chevron-right" class="w-6 h-6"></i></button>
                        </div>
                        <div id="carousel-controls" class="absolute top-0 left-0 flex items-center gap-2">
                            <span id="idea-counter" class="text-xs bg-black/40 px-2 py-1 rounded-md hidden"></span>
                            <button id="refresh-ideas" class="p-1 bg-black/40 rounded-full disabled:opacity-50 disabled:cursor-not-allowed"><i data-lucide="refresh-cw" class="w-4 h-4"></i></button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Verse of the Day -->
            <div id="verse" class="widget flex flex-col min-h-0">
                 <div class="flex-grow flex flex-col justify-center">
                    <blockquote id="verse-text" class="text-2xl italic text-shadow text-center">Loading verse...</blockquote>
                    <cite id="verse-reference" class="block text-right text-lg mt-4 font-medium text-shadow"></cite>
                </div>
                <div id="verse-click-indicator" class="text-center text-xs text-white/50 mt-2 flex-shrink-0 flex items-center justify-center gap-1 hidden">
                    <i data-lucide="book-open" class="w-3 h-3"></i>
                    <span>Click for devotional and scripture context</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Floating Action Button for Gemini Q&A -->
    <button id="open-gemini-modal" class="glass-btn">
        <i data-lucide="sparkles" class="w-6 h-6"></i>
        <span>Ask Gemini</span>
    </button>

    <!-- Mood Tracker Button -->
    <button id="mood-tracker-btn" class="glass-btn p-3 fixed bottom-6 left-1/2 -translate-x-1/2 z-50">
        <i id="overall-mood-icon" data-lucide="smile" class="w-8 h-8"></i>
    </button>

    <!-- Gemini Q&A Modal -->
    <div id="gemini-modal-overlay" class="modal-overlay" style="display: none;">
        <div id="gemini-modal" class="modal-content">
            <div class="modal-header flex justify-between items-center">
                <h2 class="text-xl font-bold">Ask a Question!</h2>
                <button id="close-gemini-modal" class="p-1 rounded-full hover:bg-white/10">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            <div class="modal-body scrollable-content">
                <textarea id="gemini-question-input" rows="3" placeholder="What is a black hole? Why is the sky blue?"></textarea>
                <div id="gemini-answer-container" class="mt-4 text-white/90">
                    <p>Your answer will appear here...</p>
                </div>
            </div>
            <div class="modal-footer flex justify-end">
                <button id="submit-gemini-question" class="gemini-btn">
                    Get Answer
                </button>
            </div>
        </div>
    </div>

    <!-- Verse Devotional Modal -->
    <div id="verse-devotional-modal-overlay" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header flex justify-between items-center">
                <h2 class="text-xl font-bold">Verse Insights</h2>
                <button id="close-verse-devotional-modal" class="p-1 rounded-full hover:bg-white/10">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            <div class="modal-body p-0">
                <div class="carousel-container h-full">
                     <div id="gemini-verse-insight-track" class="carousel-track">
                         <!-- Content will be injected by JS -->
                     </div>
                     <button id="prev-verse-insight" class="carousel-button left hidden"><i data-lucide="chevron-left" class="w-6 h-6"></i></button>
                     <button id="next-verse-insight" class="carousel-button right hidden"><i data-lucide="chevron-right" class="w-6 h-6"></i></button>
                 </div>
            </div>
        </div>
    </div>

    <!-- Feelings Wheel Modal -->
    <div id="feelings-modal-overlay" class="modal-overlay" style="display: none;">
        <div id="feelings-modal" class="modal-content">
             <div class="modal-header flex justify-between items-center">
                <h2 id="feelings-modal-title" class="text-xl font-bold">How are you feeling?</h2>
                <button id="close-feelings-modal" class="p-1 rounded-full hover:bg-white/10">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            <div class="modal-body scrollable-content">
                <div id="name-selection-view"></div>
                <div id="wheel-view" class="hidden"></div>
            </div>
        </div>
    </div>


    <script>
        // --- CONFIGURATION ---
        const WEATHER_CITY = "Greer,US";
        const WEATHER_UNITS = "imperial";
        const FAMILY_MEMBERS = ["Andrew", "Jenna", "Olivia", "Malia", "Kaci", "Declan", "Halle", "Liam"];
        
        const FEELINGS_WHEEL = {
            "Mad": {
                icon: 'angry', value: 1, color: 'bg-red-600/50',
                feelings: ["Hurt", "Worried", "Embarrassed", "Vulnerable", "Annoyed", "Defensive", "Sarcastic", "Frustrated", "Jealous", "Hostile", "Hateful", "Selfish", "Angry", "Critical", "Rattled"]
            },
            "Scared": {
                icon: 'frown', value: 2, color: 'bg-orange-500/50',
                feelings: ["Insecure", "Helpless", "Hopeless", "Anxious", "Rejected", "Confused", "Nervous", "Overwhelmed"]
            },
            "Joyful": {
                icon: 'smile', value: 5, color: 'bg-yellow-500/50',
                feelings: ["Hopeful", "Energetic", "Creative", "Excited", "Passionate", "Enthusiastic", "Amused", "Delighted", "Optimistic", "Cheerful", "Daring", "Successful"]
            },
            "Strong": {
                icon: 'smile', value: 5, color: 'bg-green-500/50',
                feelings: ["Worthy", "Appreciated", "Respected", "Proud", "Confident", "Faithful", "Assured", "Inspired", "Caring", "Fulfilled", "Motivated", "Valuable"]
            },
            "Calm": {
                icon: 'meh', value: 4, color: 'bg-blue-500/50',
                feelings: ["Trusting", "Loving", "Present", "Relaxed", "Peaceful", "Comfortable", "Safe", "Content", "Serene", "Grounded"]
            },
            "Sad": {
                icon: 'frown', value: 2, color: 'bg-indigo-500/50',
                feelings: ["Uncaring", "Hopeless", "Ashamed", "Depressed", "Miserable", "Desolate", "Guilty", "Stupid", "Lonely", "Bored", "Tired", "Sleepy"]
            }
        };


        // Static image URLs
        const WEATHER_IMAGES = {
            "clear sky": "https://images.pexels.com/photos/912364/pexels-photo-912364.jpeg?auto=compress&cs=tinysrgb&fit=crop&h=1080&w=1920",
            "few clouds": "https://images.pexels.com/photos/96622/pexels-photo-96622.jpeg?auto=compress&cs=tinysrgb&fit=crop&h=1080&w=1920",
            "scattered clouds": "https://images.pexels.com/photos/86695/pexels-photo-86695.jpeg?auto=compress&cs=tinysrgb&fit=crop&h=1080&w=1920",
            "broken clouds": "https://images.pexels.com/photos/695657/pexels-photo-695657.jpeg?auto=compress&cs=tinysrgb&fit=crop&h=1080&w=1920",
            "overcast clouds": "https://images.pexels.com/photos/8318263/pexels-photo-8318263.jpeg?auto=compress&cs=tinysrgb&fit=crop&h=1080&w=1920",
            "light rain": "https://images.pexels.com/photos/1529360/pexels-photo-1529360.jpeg?auto=compress&cs=tinysrgb&fit=crop&h=1080&w=1920",
            "moderate rain": "https://images.pexels.com/photos/459451/pexels-photo-459451.jpeg?auto=compress&cs=tinysrgb&fit=crop&h=1080&w=1920",
            "heavy intensity rain": "https://images.pexels.com/photos/2748716/pexels-photo-2748716.jpeg?auto=compress&cs=tinysrgb&fit=crop&h=1080&w=1920",
            "shower rain": "https://images.pexels.com/photos/1530423/pexels-photo-1530423.jpeg?auto=compress&cs=tinysrgb&fit=crop&h=1080&w=1920",
            "rain": "https://images.pexels.com/photos/1529360/pexels-photo-1529360.jpeg?auto=compress&cs=tinysrgb&fit=crop&h=1080&w=1920",
            "drizzle": "https://images.pexels.com/photos/1529360/pexels-photo-1529360.jpeg?auto=compress&cs=tinysrgb&fit=crop&h=1080&w=1920",
            "thunderstorm": "https://images.pexels.com/photos/1154510/pexels-photo-1154510.jpeg?auto=compress&cs=tinysrgb&fit=crop&h=1080&w=1920",
            "snow": "https://images.pexels.com/photos/954710/pexels-photo-954710.jpeg?auto=compress&cs=tinysrgb&fit=crop&h=1080&w=1920",
            "mist": "https://images.pexels.com/photos/163323/fog-dawn-landscape-morgenstimmung-163323.jpeg?auto=compress&cs=tinysrgb&fit=crop&h=1080&w=1920",
            "fog": "https://images.pexels.com/photos/163323/fog-dawn-landscape-morgenstimmung-163323.jpeg?auto=compress&cs=tinysrgb&fit=crop&h=1080&w=1920",
            "default": "https://images.pexels.com/photos/1431822/pexels-photo-1431822.jpeg?auto=compress&cs=tinysrgb&fit=crop&h=1080&w=1920"
        };

        const NLT_VERSES_FOR_DAY = [
            { text: "For I know the plans I have for you,” says the Lord. “They are plans for good and not for disaster, to give you a future and a hope.", reference: "Jeremiah 29:11 NLT" },
            { text: "Fearing people is a dangerous trap, but trusting the Lord means safety.", reference: "Proverbs 29:25 NLT" },
        ];

        // --- Global State Variables ---
        let currentVerse = {};
        let rawWeatherData = null;
        let activityIdeas = [];
        let verseInsights = [];
        let currentIdeaIndex = 0;
        let currentVerseInsightIndex = 0;
        const VERSE_HISTORY_LENGTH = 365;
        let selectedPersonForMood = null;


        // --- JSON Schemas for Gemini ---
        const verseInsightSchema = {
            type: "OBJECT",
            properties: {
                "devotional": {
                    "type": "OBJECT",
                    "properties": {
                        "title": { "type": "STRING" },
                        "story": { "type": "STRING" },
                        "big_idea": { "type": "STRING" },
                        "application_questions": { "type": "ARRAY", "items": { "type": "STRING" } },
                        "prayer": { "type": "STRING" }
                    },
                    "required": ["title", "story", "big_idea", "application_questions", "prayer"]
                },
                "context": { "type": "STRING" }
            },
            required: ["devotional", "context"]
        };

        const activitySchema = {
            type: "OBJECT",
            properties: {
                "activities": {
                    "type": "ARRAY",
                    "items": {
                        "type": "OBJECT",
                        "properties": { "title": { "type": "STRING" }, "description": { "type": "STRING" } },
                        "required": ["title", "description"]
                    }
                }
            }, 
            "required": ["activities"]
        };

        // --- APPLICATION LOGIC ---
        document.addEventListener('DOMContentLoaded', function() {
            try {
                updateTime();
                scheduleDailyVerseUpdate();
                fetchWeather(); 
                fetchConversationStarter();
                initializeFeelingsWheel();
            
                document.getElementById('refresh-ideas').addEventListener('click', fetchActivityIdeas);
                document.getElementById('prev-idea').addEventListener('click', () => showActivityIdea(currentIdeaIndex - 1));
                document.getElementById('next-idea').addEventListener('click', () => showActivityIdea(currentIdeaIndex + 1)); 
                document.getElementById('prev-verse-insight').addEventListener('click', () => showVerseInsight(currentVerseInsightIndex - 1));
                document.getElementById('next-verse-insight').addEventListener('click', () => showVerseInsight(currentVerseInsightIndex + 1));
                document.getElementById('refresh-calendar').addEventListener('click', () => {
                    document.getElementById('calendar-iframe').src = document.getElementById('calendar-iframe').src; 
                });
                document.getElementById('refresh-starter').addEventListener('click', fetchConversationStarter);

                // --- Modal Listeners ---
                const geminiModalOverlay = document.getElementById('gemini-modal-overlay');
                document.getElementById('open-gemini-modal').addEventListener('click', () => {
                    geminiModalOverlay.style.display = 'flex';
                    lucide.createIcons(); 
                });
                document.getElementById('close-gemini-modal').addEventListener('click', () => {
                    geminiModalOverlay.style.display = 'none';
                });
                geminiModalOverlay.addEventListener('click', (event) => {
                    if (event.target === geminiModalOverlay) {
                        geminiModalOverlay.style.display = 'none';
                    }
                });
                document.getElementById('submit-gemini-question').addEventListener('click', handleAskGemini);

                // --- Verse Devotional Modal Listeners ---
                const verseWidget = document.getElementById('verse');
                const verseDevotionalModalOverlay = document.getElementById('verse-devotional-modal-overlay');
                const closeVerseDevotionalModalBtn = document.getElementById('close-verse-devotional-modal');

                verseWidget.addEventListener('click', () => {
                    if (verseInsights.length > 0) {
                        verseDevotionalModalOverlay.style.display = 'flex';
                        lucide.createIcons();
                    }
                });

                closeVerseDevotionalModalBtn.addEventListener('click', () => {
                    verseDevotionalModalOverlay.style.display = 'none';
                });

                verseDevotionalModalOverlay.addEventListener('click', (event) => {
                    if (event.target === verseDevotionalModalOverlay) {
                        verseDevotionalModalOverlay.style.display = 'none';
                    }
                });
                
                setInterval(updateTime, 1000);
                setInterval(fetchWeather, 600000);

                lucide.createIcons();
            } catch (error) {
                console.error("Critical error on startup:", error);
                document.body.innerHTML = `<div class="w-screen h-screen flex justify-center items-center text-2xl">A critical error occurred. Please refresh.</div>`;
            }
        });

        function scheduleDailyVerseUpdate() {
            const now = new Date();
            const midnight = new Date(now);
            midnight.setHours(24, 0, 0, 0); 
            const msUntilMidnight = midnight.getTime() - now.getTime();
            fetchVerseOfTheDayFromGemini(); 
            setTimeout(() => {
                setInterval(fetchVerseOfTheDayFromGemini, 24 * 60 * 60 * 1000);
            }, msUntilMidnight);
        }
        
        // --- Gemini API Functions ---
    async function callGemini(prompt, model = "gemini-2.5-pro", responseSchema = null) {
    // Build the query string for Netlify Function
    const params = new URLSearchParams({ prompt, model });
    if (responseSchema) {
        params.append("responseSchema", JSON.stringify(responseSchema));
    }

    const apiUrl = `/.netlify/functions/gemini?${params.toString()}`;

    let lastError = null;
    for (let i = 0; i < 5; i++) {
        try {
            const response = await fetch(apiUrl, {
                method: 'GET'
            });

            if (response.status === 429) {
                // Rate limit: exponential backoff
                const wait = Math.pow(2, i) * 1000;
                console.warn(`Rate limited (429) on attempt ${i + 1}. Waiting ${wait}ms before retrying.`);
                lastError = new Error('Rate limited by Gemini API (429)');
                await new Promise(resolve => setTimeout(resolve, wait));
                continue;
            }
            if (response.status === 503 || response.status === 500) {
                console.warn(`API call failed with status ${response.status} (Attempt ${i + 1}). Retrying...`);
                lastError = new Error(`API call failed with status: ${response.status}`);
                await new Promise(resolve => setTimeout(resolve, (i + 1) * 1000));
                continue;
            }
            if (!response.ok) throw new Error(`API call failed with status: ${response.status}`);

            const result = await response.json();

            // Retry if no content or finishReason is STOP/undefined
            const candidate = result.candidates?.[0];
            const responseText = candidate?.content?.parts?.[0]?.text;
            if (responseText && candidate.finishReason !== 'STOP' && candidate.finishReason !== undefined) {
                if (responseSchema) {
                    try {
                        return JSON.parse(responseText);
                    } catch (e) {
                        throw new Error("Invalid JSON response from API.");
                    }
                }
                return responseText;
            } else {
                lastError = new Error(`No content received from API. Finish reason: ${candidate?.finishReason}`);
                console.warn(`No content received (Attempt ${i + 1}). Retrying...`);
                await new Promise(resolve => setTimeout(resolve, (i + 1) * 1000));
                continue;
            }
        } catch (error) {
            lastError = error;
            console.warn(`An error occurred during API call attempt ${i + 1}:`, error);
        }
    }
    throw lastError;
        }

        async function fetchVerseOfTheDayFromGemini() {
            const verseTextEl = document.getElementById('verse-text');
            const verseRefEl = document.getElementById('verse-reference');
            
            const todayKey = new Date().toISOString().slice(0, 10); 
            const cachedData = localStorage.getItem('verseData');
            const lastVerseDate = localStorage.getItem('lastVerseDate');

            if (lastVerseDate === todayKey && cachedData) {
                console.log("Loading verse and insights from localStorage for today.");
                const data = JSON.parse(cachedData);
                currentVerse = data.verse;
                verseTextEl.textContent = currentVerse.text;
                verseRefEl.textContent = currentVerse.reference;
                renderVerseCarousel(data.insights);
                return; 
            }

            verseTextEl.textContent = "Generating verse...";
            verseRefEl.textContent = "";

            try {
                let verseHistory = getVerseHistory();
                const versesToExclude = verseHistory.slice(Math.max(0, 150)); 
                let exclusionInstruction = versesToExclude.length > 0 ? ` Ensure the verse reference is NOT one of these: ${versesToExclude.join(', ')}.` : "";
                const versePrompt = `Provide one inspirational Bible verse from the NLT (New Living Translation), including its reference. Try to select a verse that is not extremely common and that can easily be used for inspiration or to give wisdom for future or present issues.${exclusionInstruction} Format it strictly as 'VERSE_TEXT (Book Chapter:Verse NLT)' with no extra commentary or formatting.`;
                
                const geminiVerseResponse = await callGemini(versePrompt);
                
                const strictMatch = geminiVerseResponse.match(/(.*)\s\(([^)]+)\sNLT\)/i);
                if (!strictMatch) throw new Error("Verse response format was incorrect.");
                
                const [_, text, reference] = strictMatch;
                currentVerse = { text: text.trim(), reference: `${reference.trim()} NLT` };
                addVerseToHistory(currentVerse.reference); 

                verseTextEl.textContent = currentVerse.text;
                verseRefEl.textContent = currentVerse.reference;

                generateAndDisplayVerseInsights(); 

            } catch (error) {
                console.error("Error fetching verse of the day from Gemini:", error);
                verseTextEl.textContent = `Failed to load verse. Falling back to a local one.`;
                verseRefEl.textContent = "Error";
                updateVerseFromLocalList(); 
            }
        }

        function getVerseHistory() {
            try {
                return JSON.parse(localStorage.getItem('verseHistory') || '[]');
            } catch (e) { return []; }
        }

        function addVerseToHistory(verseReference) {
            let history = getVerseHistory();
            const normalizedNewRef = verseReference.replace(/ NLT/i, '').trim();
            history = history.filter(ref => ref.replace(/ NLT/i, '').trim() !== normalizedNewRef); 
            history.push(verseReference); 
            if (history.length > VERSE_HISTORY_LENGTH) {
                history.shift();
            }
            localStorage.setItem('verseHistory', JSON.stringify(history));
        }
        
        async function generateAndDisplayVerseInsights() {
            const track = document.getElementById('gemini-verse-insight-track');
            if(track) track.innerHTML = `<div class="carousel-slide flex items-center justify-center w-full h-full"><div class="spinner"></div><span class="ml-2">Loading...</span></div>`;

            if (!currentVerse || !currentVerse.text) {
                if (track) track.innerHTML = `<div class="carousel-slide text-center p-4"><p>Verse not loaded. Cannot get insights.</p></div>`;
                return;
            }

            const insightPrompt = `
Act as a theologian and Bible scholar who is skilled at making deep biblical truths accessible to children.
Based on the Bible verse "${currentVerse.text}" (${currentVerse.reference}), generate a JSON object with two main keys: "devotional" and "context".

1.  The "context" key should contain a string with historically accurate information simplified for a child (age 8+). Explain who wrote it, to whom, and the situation, focusing on what was happening that makes the verse's message important.

2.  The "devotional" key should contain a JSON object with the following keys:
    * "title": A short, catchy title for the devotional that captures the main theme.
    * "story": Instead of a fictional story, briefly explain the theological principle of the verse. If possible, use a real, brief example from another Bible character who lived out this truth (e.g., how David trusted God, how Paul showed perseverance).
    * "big_idea": A single sentence summarizing the core theological truth or promise of the verse.
    * "application_questions": An array of 2-3 short, relatable questions that connect the theological truth to a child's life.
    * "prayer": A short, simple prayer a child can say that reflects the theme of the verse.

Ensure the entire output is a single, valid JSON object.`;

            try {
                const insights = await callGemini(insightPrompt, "gemini-2.5-pro", verseInsightSchema);
                renderVerseCarousel(insights);

                const todayKey = new Date().toISOString().slice(0, 10);
                localStorage.setItem('lastVerseDate', todayKey);
                localStorage.setItem('verseData', JSON.stringify({ verse: currentVerse, insights: insights }));

            } catch (error) {
                console.error("Failed to fetch consolidated insights:", error);
                if (track) track.innerHTML = `<div class="carousel-slide p-4 text-center">Could not load insights.</div>`;
            }
        }

        function renderVerseCarousel(insights) {
            const track = document.getElementById('gemini-verse-insight-track');
            const verseWidget = document.getElementById('verse');
            const indicator = document.getElementById('verse-click-indicator');
            if (!track) return;
            track.innerHTML = ''; 

            verseInsights = [];
            
            if (insights?.devotional) {
                const dev = insights.devotional;
                let devotionalContent = `
                    <div class="p-4 text-left">
                        <h5 class="font-semibold text-lg mb-2">${dev.title}</h5>
                        <p class="text-base mb-4">${dev.story}</p>
                        <h5 class="font-semibold text-lg mb-2">The Big Idea</h5>
                        <p class="text-base mb-4 italic">"${dev.big_idea}"</p>
                        <h5 class="font-semibold text-lg mb-2">Think About It</h5>
                        <div class="text-base mb-4">${(dev.application_questions || []).map(q => `• ${q}`).join('<br>')}</div>
                        <h5 class="font-semibold text-lg mb-2">Prayer</h5>
                        <p class="text-base mb-4">${dev.prayer}</p>
                    </div>
                `;
                verseInsights.push({ title: 'Devotional', content: devotionalContent });
            }

            if (insights?.context) {
                let contextContent = `
                    <div class="p-4 text-left">
                        <h5 class="font-semibold text-lg mb-2">What was happening?</h5>
                        <p class="text-base">${insights.context}</p>
                    </div>
                `;
                verseInsights.push({ title: 'Context', content: contextContent });
            }

            verseInsights.forEach(insight => {
                const slide = document.createElement('div');
                slide.className = 'carousel-slide';
                slide.innerHTML = `<div class="scrollable-content h-full w-full">${insight.content}</div>`;
                track.appendChild(slide);
            });
            
            showVerseInsight(0);
            const prevBtn = document.getElementById('prev-verse-insight');
            const nextBtn = document.getElementById('next-verse-insight');
            if (verseInsights.length > 1) {
                prevBtn.classList.remove('hidden');
                nextBtn.classList.remove('hidden');
            } else {
                prevBtn.classList.add('hidden');
                nextBtn.classList.add('hidden');
            }

            // Show indicator and make widget clickable
            if (indicator) indicator.classList.remove('hidden');
            if (verseWidget) verseWidget.classList.add('clickable');
            lucide.createIcons();
        }

        function showVerseInsight(index) {
            const track = document.getElementById('gemini-verse-insight-track');
            const prevButton = document.getElementById('prev-verse-insight');
            const nextButton = document.getElementById('next-verse-insight');
            if (!track || !prevButton || !nextButton || !verseInsights || verseInsights.length === 0) return;
            if (index < 0 || index >= verseInsights.length) return;
            
            currentVerseInsightIndex = index;
            track.style.transform = `translateX(-${currentVerseInsightIndex * 100}%)`;
            prevButton.disabled = currentVerseInsightIndex === 0;
            nextButton.disabled = currentVerseInsightIndex >= verseInsights.length - 1;
        }
        
        async function fetchActivityIdeas() {
            const refreshButton = document.getElementById('refresh-ideas');
            const insightTrack = document.getElementById('gemini-weather-insight-track');
            
            if (refreshButton) {
                refreshButton.disabled = true;
                refreshButton.innerHTML = '<div class="spinner w-4 h-4"></div>';
            }
            if (insightTrack) insightTrack.innerHTML = `<div class="carousel-slide flex items-center justify-center text-center"><span class="text-lg">✨ Loading personalized activity ideas...</span></div>`; 
            
            document.getElementById('prev-idea').classList.add('hidden');
            document.getElementById('next-idea').classList.add('hidden');
            document.getElementById('idea-counter').classList.add('hidden');

            if (!rawWeatherData) { 
                if (insightTrack) insightTrack.innerHTML = `<div class="carousel-slide text-center"><p>Weather data not yet available.</p></div>`; 
                if (refreshButton) {
                    refreshButton.disabled = false;
                    refreshButton.innerHTML = '<i data-lucide="refresh-cw" class="w-4 h-4"></i>';
                }
                lucide.createIcons();
                return; 
            }
            const weatherContext = `Today's forecast is: ${rawWeatherData.current.description}, feels like ${rawWeatherData.current.feels_like}°, with a temperature of ${rawWeatherData.current.temp}° and and humidity of ${rawWeatherData.current.humidity}%. The high for today will be ${rawWeatherData.forecast[0].maxTemp}° and the low will be ${rawWeatherData.forecast[0].minTemp}°. The chance of rain is ${rawWeatherData.forecast[0].pop}%. Sunrise is at ${rawWeatherData.current.sunrise} and sunset is at ${rawWeatherData.current.sunset}.`;
            const prompt = `You are a helpful local guide for the Andrew Weaver family with 7 children: Liam (9), Kaci (12), Declan (11), Halle (11), Malia (13), Olivia (17). Andrew is a Caucasian male, 37 years old. His wife Jenna is 37. Based on this weather information for Greer, SC: "${weatherContext}". Provide 10 diverse ideas for fun family activities or local events. Ensure a mix of creative (e.g., arts/crafts, storytelling), physical (e.g., sports, active games), quiet (e.g., reading, puzzles), family friendly local events(free preferred) and adventurous (e.g., exploring parks, new places) activities. Include both at-home (indoor or outdoor) and local (near Greer, SC) options. For each idea, provide a "title" and a short but detailed "description". Do NOT include any information or suggestions about parental supervision in the response.`;
            
            try {
                const parsedJson = await callGemini(prompt, "gemini-2.5-pro", activitySchema);
                activityIdeas = parsedJson.activities || [];
                if (activityIdeas.length > 0) {
                    renderActivityCarousel();
                } else {
                    if (insightTrack) insightTrack.innerHTML = `<div class="carousel-slide text-center"><p>Sorry, couldn't get ideas right now.</p></div>`;
                }
            } catch (error) {
                console.error("Error calling Gemini API for weather:", error);
                if (insightTrack) insightTrack.innerHTML = `<div class="carousel-slide text-center"><p>Sorry, couldn't get ideas right now due to an API error.</p></div>`;
            } finally {
                if (refreshButton) {
                    refreshButton.disabled = false;
                    refreshButton.innerHTML = '<i data-lucide="refresh-cw" class="w-4 h-4"></i>';
                }
                lucide.createIcons();
            }
        }

        function renderActivityCarousel() {
            const insightTrack = document.getElementById('gemini-weather-insight-track');
            if (!insightTrack) return;

            insightTrack.innerHTML = ''; 
            activityIdeas.forEach(idea => {
                const slide = document.createElement('div');
                slide.className = 'carousel-slide flex flex-col items-center justify-center text-center'; 
                slide.innerHTML = `
                    <h4 class="font-bold text-lg">${idea.title}</h4>
                    <div class="scrollable-content" style="max-height: 150px; overflow-y: auto;">
                        <p class="text-sm mt-1">${idea.description}</p>
                    </div>
                `;
                insightTrack.appendChild(slide);
            });

            if (activityIdeas.length > 1) {
                document.getElementById('prev-idea').classList.remove('hidden');
                document.getElementById('next-idea').classList.remove('hidden');
                document.getElementById('idea-counter').classList.remove('hidden');
            }
            document.getElementById('refresh-ideas').classList.remove('hidden');
            showActivityIdea(0);
        }

        function showActivityIdea(index) {
            const track = document.getElementById('gemini-weather-insight-track');
            const counter = document.getElementById('idea-counter');
            const prevButton = document.getElementById('prev-idea');
            const nextButton = document.getElementById('next-idea'); 
            if (!track || !counter || !prevButton || !nextButton || !activityIdeas || activityIdeas.length === 0) return; 
            if (index < 0 || index >= activityIdeas.length) return;
            currentIdeaIndex = index;
            track.style.transform = `translateX(-${currentIdeaIndex * 100}%)`;
            counter.textContent = `${currentIdeaIndex + 1} / ${activityIdeas.length}`;
            prevButton.disabled = currentIdeaIndex === 0;
            nextButton.disabled = currentIdeaIndex === activityIdeas.length - 1;
        }

        function updateTime() {
            const now = new Date();
            const timeEl = document.getElementById('time');
            const ampmEl = document.getElementById('ampm');
            const dateEl = document.getElementById('date');
            if (!timeEl || !dateEl || !ampmEl) return;
            const hours = now.getHours();
            const minutes = String(now.getMinutes()).padStart(2, '0');
            ampmEl.textContent = hours >= 12 ? 'PM' : 'AM';
            const formattedHours = hours % 12 || 12;
            timeEl.textContent = `${formattedHours}:${minutes}`;
            dateEl.textContent = now.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
        }
        
        async function updateStaticBackground(weatherDescription) {
            const bodyElement = document.body;
            const normalizedWeatherDescription = weatherDescription.toLowerCase();
            const imageUrl = WEATHER_IMAGES[normalizedWeatherDescription] || WEATHER_IMAGES.default;
            
            const img = new Image();
            img.src = imageUrl;
            img.onload = () => {
                bodyElement.style.backgroundImage = `linear-gradient(rgba(0,0,0,0.4), rgba(0,0,0,0.4)), url('${imageUrl}')`;
            };
            img.onerror = () => {
                bodyElement.style.backgroundImage = `linear-gradient(rgba(0,0,0,0.4), rgba(0,0,0,0.4)), url('${WEATHER_IMAGES.default}')`;
            };
        }
        
        function updateVerseFromLocalList() { 
            const today = new Date();
            const dayOfYear = Math.floor((today - new Date(today.getFullYear(), 0, 0)) / (1000 * 60 * 60 * 24));
            currentVerse = NLT_VERSES_FOR_DAY[dayOfYear % NLT_VERSES_FOR_DAY.length];
            
            document.getElementById('verse-text').textContent = currentVerse.text;
            document.getElementById('verse-reference').textContent = currentVerse.reference;
            generateAndDisplayVerseInsights();
        }

        function formatUnixTime(timestamp) {
            return new Date(timestamp * 1000).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
        }

        function fetchWeather() {
    const city = WEATHER_CITY || "London";
    const units = WEATHER_UNITS || "imperial";
    const currentWeatherUrl = `/.netlify/functions/weather?city=${encodeURIComponent(city)}&units=${encodeURIComponent(units)}`;
    let currentData;
    fetch(currentWeatherUrl)
        .then(response => response.json())
        .then(data => {
            if (data.cod != 200) throw new Error(data.message || "Invalid weather response");
            currentData = data;
            document.getElementById('weather-temp').textContent = `${Math.round(data.main.temp)}°`;
            document.getElementById('weather-description').textContent = data.weather[0].description;
            document.getElementById('humidity').textContent = `${data.main.humidity}%`;
            document.getElementById('feels-like').textContent = `${Math.round(data.main.feels_like)}°`;
            document.getElementById('temp-high').textContent = `${Math.round(data.main.temp_max)}°`;
            document.getElementById('temp-low').textContent = `${Math.round(data.main.temp_min)}°`;
            document.getElementById('sunrise-time').textContent = formatUnixTime(data.sys.sunrise);
            document.getElementById('sunset-time').textContent = formatUnixTime(data.sys.sunset);
            document.getElementById('weather-icon').setAttribute('data-lucide', getWeatherIcon(data.weather[0].icon));
            updateStaticBackground(data.weather[0].description);

            // For forecast, call the function again with a different endpoint
            const forecastUrl = `/.netlify/functions/weather?city=${encodeURIComponent(city)}&units=${encodeURIComponent(units)}&type=forecast`;
            return fetch(forecastUrl);
        })
        .then(response => response.json())
        .then(data => {
            if (data.cod != "200") throw new Error(data.message || "Invalid forecast response");
            document.getElementById('weather-loading').classList.add('hidden');
            document.getElementById('weather-content').classList.remove('hidden');
            const forecastContainerEl = document.getElementById('weather-forecast');
            forecastContainerEl.innerHTML = '';
            const hourlyForecastContainer = document.getElementById('hourly-forecast');
            hourlyForecastContainer.innerHTML = '';
            const dailyForecasts = {};
            const hourlyData = [];
            if (data.list?.length) {
                const now = new Date().getTime() / 1000;
                for(const forecast of data.list) {
                        if (forecast.dt >= now && hourlyData.length < 6) { 
                            hourlyData.push({
                                time: new Date(forecast.dt * 1000).toLocaleTimeString('en-US', { hour: 'numeric', hour12: true }).replace(' ', ''),
                                temp: Math.round(forecast.main.temp),
                                icon: getWeatherIcon(forecast.weather[0].icon),
                                pop: Math.round(forecast.pop * 100) 
                            });
                        }
                        const date = new Date(forecast.dt_txt).toLocaleDateString();
                        if (!dailyForecasts[date]) dailyForecasts[date] = { temps: [], icons: [], pops: [] };
                        dailyForecasts[date].temps.push(forecast.main.temp);
                        dailyForecasts[date].icons.push(forecast.weather[0].icon);
                        dailyForecasts[date].pops.push(forecast.pop); 
                    }
                }
                for (const hour of hourlyData) {
                    const hourWrapper = document.createElement('div');
                    hourWrapper.className = 'forecast-item'; 
                    hourWrapper.innerHTML = `<p class="font-semibold">${hour.time}</p><i class="w-8 h-8 my-1" data-lucide="${hour.icon}"></i><p>${hour.temp}°</p><div class="flex items-center gap-0.5 text-xs"><i data-lucide="umbrella" class="w-3 h-3"></i><span>${hour.pop}%</span></div>`;
                    hourlyForecastContainer.appendChild(hourWrapper);
                }
                const forecastForPrompt = [];
                const forecastToDisplay = [];
                const sortedDates = Object.keys(dailyForecasts).sort((a,b) => new Date(a) - new Date(b));
                for (const dateStr of sortedDates) {
                    const dayData = dailyForecasts[dateStr];
                    const dayDate = new Date(dateStr);
                    const dayInfo = { dayName: dayDate.toLocaleDateString('en-US', { weekday: 'short' }), icon: getWeatherIcon(dayData.icons[Math.floor(dayData.icons.length / 2)]), maxTemp: Math.round(Math.max(...dayData.temps)), minTemp: Math.round(Math.min(...dayData.temps)), pop: Math.round(Math.max(...dayData.pops) * 100) };
                    if (forecastForPrompt.length < 6) forecastForPrompt.push(dayInfo);
                    if (dayDate.toDateString() !== new Date().toDateString() && forecastToDisplay.length < 5) { forecastToDisplay.push(dayInfo); }
                }
                for (const day of forecastToDisplay) {
                    const dayWrapper = document.createElement('div');
                    dayWrapper.className = 'forecast-item';
                    dayWrapper.innerHTML = `<p class="day-name">${day.dayName}</p><i class="w-8 h-8 my-1" data-lucide="${day.icon}"></i><p class="temp-range">${day.maxTemp}°/${day.minTemp}°</p><div class="flex items-center gap-1 text-xs"><i class="w-3 h-3" data-lucide="umbrella"></i><span>${day.pop}%</span></div>`;
                    forecastContainerEl.appendChild(dayWrapper);
                }
                rawWeatherData = { current: { temp: Math.round(currentData.main.temp), feels_like: Math.round(currentData.main.feels_like), humidity: currentData.main.humidity, description: currentData.weather[0].description, sunrise: formatUnixTime(currentData.sys.sunrise), sunset: formatUnixTime(currentData.sys.sunset) }, forecast: forecastForPrompt };
                document.getElementById('chance-of-rain').textContent = `${rawWeatherData.forecast[0].pop}%`; 
                lucide.createIcons(); 
                fetchActivityIdeas(); 
            }).catch(error => { console.error('Error fetching weather data:', error); 
                document.getElementById('weather-loading').textContent = 'Weather Unavailable'; 
            });
        }

        function getWeatherIcon(iconCode) {
            switch(iconCode) {
                case '01d': return 'sun'; case '01n': return 'moon';
                case '02d': return 'cloud-sun'; case '02n': return 'cloud-moon';
                case '03d': case '03n': return 'cloud';
                case '04d': case '04n': return 'cloudy';
                case '09d': case '09n': return 'cloud-drizzle';
                case '10d': return 'cloud-rain-wind'; case '10n': return 'cloud-rain';
                case '11d': case '11n': return 'cloud-lightning';
                case '13d': case '13n': return 'cloud-snow';
                case '50d': case '50n': return 'wind';
                default: return 'sun';
            }
        }

        // --- Gemini Q&A Modal Functions ---
        async function handleAskGemini() {
            const questionInput = document.getElementById('gemini-question-input');
            const answerContainer = document.getElementById('gemini-answer-container');
            const submitButton = document.getElementById('submit-gemini-question');
            
            const question = questionInput.value.trim();
            if (!question) {
                answerContainer.innerHTML = '<p class="text-yellow-400">Please enter a question.</p>';
                return;
            }

            submitButton.disabled = true;
            submitButton.innerHTML = '<div class="spinner w-4 h-4 mx-auto"></div>';
            answerContainer.innerHTML = '<div class="flex items-center justify-center"><div class="spinner w-6 h-6"></div><p class="ml-2">Thinking...</p></div>';
            lucide.createIcons();

            const safetyPrompt = `
                You are a friendly, patient, and knowledgeable AI assistant for children.
                A child has asked the following question: "${question}"
                
                Your task is to answer this question in a way that is simple, engaging, and easy for a child (ages 8-13) to understand. Use analogies and simple examples where possible.
                
                IMPORTANT SAFETY RULES:
                - You MUST NOT answer questions about or use language related to violence, weapons, self-harm, hate speech, sexual topics, drugs, alcohol, gambling, or any other mature or inappropriate themes.
                - If the user's question touches on any of these forbidden topics, you MUST refuse to answer directly. Instead, respond with a gentle and friendly refusal like: "That's a very grown-up question! I'm here to help with topics like science, animals, history, and homework. How about we talk about something else, like why dinosaurs are so cool?" and encourage the child to speak to their parents about that topic.
                - Keep your answers positive and encouraging.
            `;
            
            try {
                const answer = await callGemini(safetyPrompt);
                answerContainer.innerHTML = `<p>${answer.replace(/\n/g, '<br>')}</p>`;
            } catch (error) {
                console.error("Error asking Gemini:", error);
                answerContainer.innerHTML = '<p class="text-red-400">Sorry, I had trouble thinking of an answer. Please try again!</p>';
            } finally {
                submitButton.disabled = false;
                submitButton.innerHTML = 'Get Answer';
                lucide.createIcons();
            }
        }

        async function fetchConversationStarter() {
            const questionEl = document.getElementById('starter-question');
            const refreshBtn = document.getElementById('refresh-starter');
            
            refreshBtn.disabled = true;
            questionEl.textContent = 'Thinking of a new question...';

            // Get history to avoid repetition
            let questionHistory = [];
            try {
                questionHistory = JSON.parse(localStorage.getItem('questionHistory') || '[]');
            } catch (e) {
                questionHistory = [];
            }

            const exclusionPrompt = questionHistory.length > 0 ? `Please do not ask a question similar to these recent ones: "${questionHistory.join('", "')}"` : "";

            const prompt = `Generate a single, fun, and thought-provoking conversation starter question suitable for a family with children of various ages (8-17). The question should be open-ended and encourage imagination or sharing personal stories. Do not include any introductory text, just the question itself. ${exclusionPrompt}`;

            try {
                const question = await callGemini(prompt);
                questionEl.textContent = question;

                // Update history
                questionHistory.push(question);
                if (questionHistory.length > 10) { // Keep the last 10 questions
                    questionHistory.shift();
                }
                localStorage.setItem('questionHistory', JSON.stringify(questionHistory));

            } catch (error) {
                console.error("Error fetching conversation starter:", error);
                questionEl.textContent = 'What is your favorite family memory?'; // Fallback question
            } finally {
                refreshBtn.disabled = false;
            }
        }

        // --- Feelings Wheel Functions ---
        function initializeFeelingsWheel() {
            const modalOverlay = document.getElementById('feelings-modal-overlay');
            const openBtn = document.getElementById('mood-tracker-btn');
            const closeBtn = document.getElementById('close-feelings-modal');
            
            const closeAndResetFeelingsModal = () => {
                modalOverlay.style.display = 'none';
                // Reset the view to name selection for the next time it opens
                document.getElementById('wheel-view').classList.add('hidden');
                document.getElementById('name-selection-view').classList.remove('hidden');
            };

            openBtn.addEventListener('click', () => {
                showNameSelection();
                modalOverlay.style.display = 'flex';
                lucide.createIcons();
            });

            closeBtn.addEventListener('click', closeAndResetFeelingsModal);
            
            modalOverlay.addEventListener('click', (event) => {
                if(event.target === modalOverlay) {
                    closeAndResetFeelingsModal();
                }
            });

            updateOverallMoodIcon();
        }

        function getFamilyFeelings() {
            try {
                return JSON.parse(localStorage.getItem('familyFeelings') || '{}');
            } catch (e) { return {}; }
        }

        function saveFamilyFeelings(feelings) {
            localStorage.setItem('familyFeelings', JSON.stringify(feelings));
        }

        function showNameSelection() {
            const nameView = document.getElementById('name-selection-view');
            const wheelView = document.getElementById('wheel-view');
            const title = document.getElementById('feelings-modal-title');
            
            nameView.innerHTML = '';
            nameView.classList.remove('hidden');
            wheelView.classList.add('hidden');
            title.textContent = 'How are you feeling?';

            const familyFeelings = getFamilyFeelings();

            FAMILY_MEMBERS.forEach(name => {
                const personData = familyFeelings[name];
                const button = document.createElement('button');
                button.className = 'name-btn';
                button.dataset.name = name;

                let lastFeelingHTML = '<span class="text-xs text-white/50">Click to select a feeling</span>';
                if (personData) {
                    const lastUpdated = new Date(personData.lastUpdated).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    lastFeelingHTML = `<span class="text-sm">${personData.feeling} <span class="text-xs text-white/50">(${lastUpdated})</span></span>`;
                }

                button.innerHTML = `<div class="flex justify-between items-center">
                                        <span class="font-bold text-lg">${name}</span>
                                        ${lastFeelingHTML}
                                    </div>`;
                button.addEventListener('click', () => showWheelForPerson(name));
                nameView.appendChild(button);
            });
        }

        function showWheelForPerson(name) {
            selectedPersonForMood = name;
            const nameView = document.getElementById('name-selection-view');
            const wheelView = document.getElementById('wheel-view');
            const title = document.getElementById('feelings-modal-title');

            nameView.classList.add('hidden');
            wheelView.classList.remove('hidden');
            wheelView.innerHTML = '';
            title.innerHTML = `<button id="back-to-names" class="p-1 mr-2 rounded-full hover:bg-white/10"><i data-lucide="arrow-left" class="w-5 h-5"></i></button> How are you feeling, ${name}?`;
            document.getElementById('back-to-names').addEventListener('click', showNameSelection);

            for (const coreEmotion in FEELINGS_WHEEL) {
                const data = FEELINGS_WHEEL[coreEmotion];
                const group = document.createElement('div');
                group.className = 'core-emotion-group';

                let feelingsHTML = '';
                data.feelings.forEach(feeling => {
                    feelingsHTML += `<button class="feeling-btn" data-core="${coreEmotion}" data-feeling="${feeling}">${feeling}</button>`;
                });

                group.innerHTML = `
                    <div class="group-header ${data.color}" data-target="${coreEmotion}-list">
                        <h3>${coreEmotion}</h3>
                        <i data-lucide="chevron-down" class="chevron"></i>
                    </div>
                    <div id="${coreEmotion}-list" class="feelings-list">
                        ${feelingsHTML}
                    </div>
                `;
                wheelView.appendChild(group);
            }

            wheelView.querySelectorAll('.group-header').forEach(header => {
                header.addEventListener('click', () => {
                    const targetId = header.dataset.target;
                    const list = document.getElementById(targetId);
                    header.classList.toggle('open');
                    list.classList.toggle('open');
                });
            });

            wheelView.querySelectorAll('.feeling-btn').forEach(button => {
                button.addEventListener('click', handleFeelingSelection);
            });
            lucide.createIcons();
        }

        function handleFeelingSelection(event) {
            const { core, feeling } = event.currentTarget.dataset;
            const familyFeelings = getFamilyFeelings();

            familyFeelings[selectedPersonForMood] = {
                feeling: feeling,
                coreEmotion: core,
                lastUpdated: new Date().toISOString()
            };
            saveFamilyFeelings(familyFeelings);
            
            // Close and reset the modal
            const modalOverlay = document.getElementById('feelings-modal-overlay');
            modalOverlay.style.display = 'none';
            document.getElementById('wheel-view').classList.add('hidden');
            document.getElementById('name-selection-view').classList.remove('hidden');

            updateOverallMoodIcon();
        }

        function updateOverallMoodIcon() {
            const btnIcon = document.getElementById('overall-mood-icon');
            if (!btnIcon) return;

            const familyFeelings = getFamilyFeelings();
            const feelingsArray = Object.values(familyFeelings);

            if (feelingsArray.length === 0) {
                btnIcon.setAttribute('data-lucide', 'smile');
                lucide.createIcons();
                return;
            }

            let totalValue = 0;
            feelingsArray.forEach(data => {
                const coreEmotionData = FEELINGS_WHEEL[data.coreEmotion];
                if (coreEmotionData) {
                    totalValue += coreEmotionData.value;
                }
            });

            const averageValue = totalValue / feelingsArray.length;
            let overallIcon = 'smile';
            if (averageValue < 2.5) {
                overallIcon = 'frown';
            } else if (averageValue < 4) {
                overallIcon = 'meh';
            }

            btnIcon.setAttribute('data-lucide', overallIcon);
            lucide.createIcons();
        }


    </script>
</body>
</html>
